<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatically Fill Official PDF Forms Online | FormFillAI</title>
    <meta name="description" content="Automatically fill official PDF forms online with FormFillAI. Upload a fillable PDF and JSON data to get back a ready-to-submit form.">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --primary: #2563eb;
            --text: #0f172a;
            --muted: #64748b;
            --error: #dc2626;
            --success: #16a34a;
            
            /* Extended theme system */
            --surface: #ffffff;
            --surface-2: #f8fafc;
            --border: #e2e8f0;
            --accent: #2563eb;
            --accent-contrast: #ffffff;
            --text-muted: rgba(15, 23, 42, 0.7);
            --hover-bg: #f1f5f9;
            --active-bg: #eff6ff;
            --focus-ring: rgba(37, 99, 235, 0.5);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --card: #1e293b;
                --text: #f1f5f9;
                --muted: #94a3b8;
                --surface: #1e293b;
                --surface-2: #0f172a;
                --border: #334155;
                --text-muted: rgba(226, 232, 240, 0.75);
                --hover-bg: #334155;
                --active-bg: #1e3a8a;
                --focus-ring: rgba(96, 165, 250, 0.5);
            }
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page-wrapper {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .content-wrapper {
            width: min(980px, 100% - 48px);
            margin: 0 auto;
            padding: 16px;
        }
        /* Legacy support - can be removed if not used elsewhere */
        /* Ensure header/buttons have proper stacking context */
        header.site-header,
        .header-inner,
        .header-right,
        .auth-btn {
            position: relative;
            z-index: 5; /* Lower than modals but ensures stacking context */
        }
        header.site-header {
            height: 56px;
            flex: 0 0 56px;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100; /* Keep header above content */
            border-bottom: 1px solid var(--border);
            overflow: visible;
        }
        .header-inner {
            width: min(980px, 100% - 48px);
            margin: 0 auto;
            padding: 0 24px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .brand {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text);
        }
        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        main.site-main {
            flex: 1;
            width: 100%;
            overflow: visible;
        }
        main.site-main .container {
            width: min(980px, 100% - 48px);
            margin: 0 auto;
            padding: 16px 24px 24px;
        }
        .hero {
            margin: 10px 0 16px;
            text-align: center;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
            overflow: visible;
        }
        .hero h1 {
            margin: 0 0 6px;
            font-size: clamp(26px, 2.2vw, 40px);
            line-height: 1.15;
            font-weight: 700;
            overflow: visible;
        }
        .hero p.sub {
            margin: 0;
            font-size: clamp(13px, 1.1vw, 16px);
            color: var(--muted);
            line-height: 1.5;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin-top: 0;
        }
        @media (min-width: 1024px) {
            .main-content.has-preview {
                grid-template-columns: 1fr 1fr;
                gap: 18px;
            }
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
            width: 100%;
            padding: 20px;
        }
        .upload-card {
            margin-top: 14px;
        }
        .pricing {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 14px;
        }
        .pricing-tier {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 18px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .pricing-title {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin: 0;
        }
        .pricing-title h2 {
            margin: 0;
            font-size: 1.1rem;
        }
        .price {
            font-weight: 700;
        }
        .pricing-tier ul {
            margin: 0;
            padding-left: 1.2rem;
            color: var(--muted);
            font-size: 0.95rem;
            list-style: none;
        }
        .pricing-tier ul li {
            margin-bottom: 6px;
        }
        .pricing-tier form {
            margin-top: auto;
        }
        .pricing-tier button {
            height: 44px;
            width: 100%;
            margin-top: 0;
        }
        form {
            margin-top: 0.75rem;
            display: grid;
            gap: 0.75rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
        }
        input[type="file"], input[type="text"], input[type="checkbox"], select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        textarea {
            font-family: inherit;
            resize: vertical;
        }
        .helper {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 0.2rem;
        }
        button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 0.85rem 1.2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            min-height: 40px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .note {
            background: #eff6ff;
            color: #1d4ed8;
            border-radius: 10px;
            padding: 0.75rem;
            font-size: 0.95rem;
        }
        #fields-container {
            display: none;
            margin-top: 1rem;
        }
        .field-group {
            margin-bottom: 1rem;
        }
        .field-group label {
            display: flex;
            align-items: center;
        }
        .advanced-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        .advanced-toggle {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
            padding: 0;
        }
        .advanced-content {
            display: none;
            margin-top: 1rem;
        }
        .advanced-content.show {
            display: block;
        }
        #status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        #status.error {
            background: #fee2e2;
            color: var(--error);
        }
        #status.success {
            background: #dcfce7;
            color: var(--success);
        }
        #ai-text-area {
            min-height: 100px;
        }
        .ai-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .ai-section h3 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
        }
        #preview-container {
            display: none;
            width: 100%;
        }
        #preview-container:not([data-has-preview]) {
            display: none !important;
        }
        .preview-placeholder {
            padding: 3rem 2rem;
            text-align: center;
            background: var(--surface-2);
            border: 2px dashed var(--border);
            border-radius: 8px;
            color: var(--text-muted);
        }
        @media (min-width: 1024px) {
            #preview-container {
                display: block;
            }
            #preview-container .card {
                position: sticky;
                top: 1.5rem;
                align-self: start;
                height: fit-content;
                max-height: calc(100vh - 3rem);
                overflow-y: auto;
            }
        }
        @media (max-width: 1023px) {
            #preview-container .card {
                position: static;
            }
        }
        .preview-wrapper {
            position: relative;
            width: 100%;
            height: 80vh;
            min-height: 500px;
            max-height: 90vh;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #f8fafc;
            overflow: hidden;
        }
        @media (min-width: 1024px) {
            .preview-wrapper {
                height: 70vh;
                min-height: 600px;
                max-height: calc(100vh - 250px);
            }
        }
        #preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .preview-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        .preview-controls button {
            background: rgba(15, 23, 42, 0.9);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, transform 0.1s;
        }
        .preview-controls button:hover {
            background: rgba(15, 23, 42, 1);
            transform: scale(1.05);
        }
        .preview-controls button:active {
            transform: scale(0.98);
        }
        .preview-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .preview-controls button:hover {
            background: #ffffff;
        }
        .preview-fallback {
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .preview-fallback a {
            color: var(--primary);
            text-decoration: underline;
        }
        .preview-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .preview-actions button {
            flex: 1;
        }
        /* Fullscreen modal */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
        }
        .fullscreen-modal:not([hidden]) {
            display: flex;
            pointer-events: auto; /* Active modal can receive clicks */
        }
        .fullscreen-header {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .fullscreen-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.1rem;
        }
        .fullscreen-close {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .fullscreen-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .fullscreen-iframe-container {
            flex: 1;
            width: 100%;
            overflow: hidden;
        }
        .fullscreen-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Responsive adjustments */
        @media (max-width: 820px) {
            .header-inner,
            main.site-main .container {
                width: calc(100% - 24px);
                padding-left: 12px;
                padding-right: 12px;
            }
            .pricing {
                grid-template-columns: 1fr;
            }
            main.site-main .container {
                padding-top: 12px;
            }
            .hero {
                margin: 8px 0 12px;
            }
            .hero h1 {
                font-size: clamp(22px, 5vw, 28px);
            }
            .hero p.sub {
                font-size: clamp(12px, 3vw, 14px);
            }
            header.site-header {
                height: auto;
                min-height: 56px;
            }
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
                padding-top: 8px;
                padding-bottom: 8px;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }
            .preview-wrapper {
                height: 70vh;
                min-height: 400px;
            }
            .preview-controls {
                top: 0.25rem;
                right: 0.25rem;
            }
            .preview-controls button {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            .preview-actions {
                flex-direction: column;
            }
        }
        .ai-fix-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .ai-fix-section h3 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .lang-switcher {
            position: relative;
        }
        .lang-picker-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .lang-picker-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
        }
        .lang-picker-btn:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }
        .lang-picker-btn .flag {
            font-size: 1.2rem;
        }
        .lang-picker-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            width: 320px;
            max-width: calc(100vw - 2rem);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow: hidden;
            flex-direction: column;
            z-index: 1000;
        }
        @media (prefers-color-scheme: dark) {
            .lang-picker-dropdown {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }
        }
        .lang-picker-dropdown.open {
            display: flex;
        }
        .lang-picker-search {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        .lang-picker-search input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--surface-2);
            color: var(--text);
            transition: border-color 0.2s;
        }
        .lang-picker-search input:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-color: var(--accent);
        }
        .lang-picker-search input::placeholder {
            color: var(--text-muted);
        }
        .lang-picker-list {
            overflow-y: auto;
            max-height: 320px;
            background: var(--surface);
        }
        .lang-picker-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            color: var(--text);
        }
        .lang-picker-item:hover {
            background: var(--hover-bg);
        }
        .lang-picker-item:focus {
            background: var(--hover-bg);
            outline: 2px solid var(--focus-ring);
            outline-offset: -2px;
        }
        .lang-picker-item.active {
            background: var(--active-bg);
            font-weight: 600;
            color: var(--text);
        }
        .lang-picker-item.active:hover {
            background: var(--active-bg);
        }
        .lang-picker-item .flag {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .lang-picker-item .names {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        .lang-picker-item .native-name {
            font-weight: 500;
            color: var(--text);
        }
        .lang-picker-item .english-name {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        /* Ensure active state maintains contrast - native name stays text, english name stays muted */
        .lang-picker-item.active .native-name {
            color: var(--text);
        }
        .lang-picker-item.active .english-name {
            color: var(--text-muted);
        }
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                align-items: flex-end;
            }
            .lang-picker-dropdown {
                right: auto;
                left: 0;
                width: 100%;
            }
        }
        .header-controls {
            display: none;
        }
        .auth-section {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .auth-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        .auth-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
        }
        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .auth-btn.primary {
            background: var(--accent);
            color: var(--accent-contrast);
            border-color: var(--accent);
        }
        .auth-btn.primary:hover {
            background: #1d4ed8;
        }
        .user-pill {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            position: relative;
        }
        .user-pill:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
        }
        .user-pill .email {
            font-weight: 500;
            color: var(--text);
        }
        .user-pill .plan-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .user-pill .plan-badge.free {
            background: #e2e8f0;
            color: #475569;
        }
        .user-pill .plan-badge.pro {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .user-pill .chevron {
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .user-pill.open .chevron {
            transform: rotate(180deg);
        }
        .user-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 180px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 1000;
        }
        .user-dropdown.open {
            display: block;
        }
        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.15s;
        }
        .user-dropdown-item:hover {
            background: var(--hover-bg);
        }
        .user-dropdown-item:first-child {
            border-bottom: 1px solid var(--border);
        }
        @media (prefers-color-scheme: dark) {
            .user-dropdown {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }
        }
        .profile-selector {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .profile-selector select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            font-size: 0.95rem;
        }
        .save-profile-btn {
            margin-top: 0.5rem;
            background: #059669;
        }
        /* Permanent CSS fix: hidden overlays do not intercept clicks */
        [hidden] {
            display: none !important;
        }
        
        .login-modal,
        .fullscreen-modal,
        .modal,
        .overlay,
        .backdrop {
            display: none;            /* important */
            pointer-events: none;     /* important */
        }
        
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .login-modal.active {
            display: flex;
            pointer-events: auto; /* Active modal can receive clicks */
        }
        .login-modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        #profileModalContent {
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        #profileModalContent > div:last-child {
            position: sticky;
            bottom: 0;
            background: var(--surface);
            padding-top: 12px;
            margin-top: auto;
            border-top: 1px solid var(--border);
        }
        .login-modal-content h3 {
            margin: 0 0 0.5rem;
            color: var(--text);
            font-size: 1.5rem;
        }
        .login-modal-content p {
            margin: 0 0 1.5rem;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .login-modal-content input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-2);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .login-modal-content input:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-color: var(--accent);
        }
        .login-modal-content button {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .login-modal-content button.secondary {
            background: var(--surface-2);
            color: var(--text);
        }
        .login-modal-content button.secondary:hover {
            background: var(--hover-bg);
        }
        .login-status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .login-status.success {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.3);
        }
        .login-status.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        .login-status.info {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent);
            border: 1px solid rgba(37, 99, 235, 0.3);
        }
        /* Debug panel - always visible in production */
        #debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            color: #0f0;
            z-index: 10000;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: block;
        }
        #debug-panel-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        #debug-panel-content div {
            line-height: 1.4;
            word-break: break-word;
        }
        .dev-link {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--surface-2);
            border: 1px dashed var(--border);
            border-radius: 6px;
            word-break: break-all;
            font-size: 0.85rem;
            font-family: monospace;
        }
        .dev-link a {
            color: var(--accent);
            text-decoration: none;
        }
        .dev-link a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .header-controls {
                position: static;
                justify-content: flex-end;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="site-header">
            <div class="header-inner">
                <a href="/" id="homeLogo" style="text-decoration: none; color: inherit;"><div class="brand">FormFillAI</div></a>
                <div class="header-right">
                    <div class="lang-switcher">
                        <button class="lang-picker-btn" id="lang-picker-btn" aria-label="Select language" aria-haspopup="true" aria-expanded="false">
                            <span class="flag" id="lang-picker-flag">ðŸ‡¬ðŸ‡§</span>
                            <span id="lang-picker-text">English</span>
                            <span style="margin-left: 0.25rem;">â–¼</span>
                        </button>
                        <div class="lang-picker-dropdown" id="lang-picker-dropdown" role="menu" aria-label="Language selection">
                            <div class="lang-picker-search">
                                <input type="text" id="lang-picker-search" placeholder="Search language..." data-i18n-placeholder="search_language" autocomplete="off" aria-label="Search languages">
            </div>
                            <div class="lang-picker-list" id="lang-picker-list" role="listbox"></div>
                        </div>
                    </div>
                    <div class="auth-section">
                        <div id="auth-logged-out">
                            <button type="button" class="auth-btn primary" id="signInBtn">Sign in</button>
                        </div>
                        <div id="auth-logged-in" style="display: none;">
                            <div class="user-pill" id="user-pill">
                                <span class="email" id="user-email"></span>
                                <span class="plan-badge" id="plan-badge" style="display: none;"></span>
                                <span class="chevron">â–¼</span>
                            </div>
                            <div class="user-dropdown" id="user-dropdown">
                                <button class="user-dropdown-item" id="profiles-menu-item">Profiles</button>
                                <button class="user-dropdown-item" id="logout-menu-item">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main class="site-main">
            <div class="container">
                <section class="hero">
                    <h1 data-i18n="title">Automatically Fill Official PDF Forms Online</h1>
                    <p class="sub" data-i18n="subtitle">Upload a fillable PDF, fill the fields, and get back a ready-to-submit form.</p>
                </section>
                <div class="main-content" id="main-content-grid">
                    <section class="card upload-card">
            <div class="note" data-i18n="note">Max file size 10MB. PDFs without form fields will return an error.</div>
            <form id="upload-form" action="/fill" method="post" enctype="multipart/form-data">
                <div>
                    <label for="pdf_file" data-i18n="fillable_pdf">Fillable PDF</label>
                    <input type="file" id="pdfFileInput" name="pdf_file" accept=".pdf,application/pdf" required>
                </div>
                <button type="button" id="analyzeBtn" data-i18n="analyze_pdf">Analyze PDF</button>
                
                <div id="fields-container">
                    <div id="profile-selector-container" class="profile-selector" style="display: none;">
                        <label for="profile-select" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Saved Profiles</label>
                        <select id="profile-select">
                            <option value="">-- Select a profile --</option>
                        </select>
                        <button type="button" id="save-profile-btn" class="save-profile-btn" style="display: none; margin-top: 0.5rem; width: 100%;">Save Current Fields as Profile</button>
                    </div>
                    <h3 id="fields-summary"></h3>
                    <div id="fields-list"></div>
                    
                    <div class="ai-section">
                        <h3 data-i18n="ai_section_title">AI-Assisted Fill (Optional)</h3>
                        <label for="ai_text" data-i18n="ai_text_label">Tell us anything you want to fill</label>
                        <textarea id="ai_text" name="ai_text" rows="4" data-i18n-placeholder="ai_text_placeholder" placeholder="Example: My name is John Doe, I live in Chicago, zip code 60661, email john@example.com, phone 555-1234..."></textarea>
                        <button type="button" id="ai-extract-btn" style="margin-top: 0.5rem; background: #059669;" data-i18n="auto_fill_ai">Auto-Fill with AI</button>
                        <p class="helper" style="margin-top: 0.5rem; font-size: 0.85rem;" data-i18n="ai_helper">AI will only fill empty fields. It won't overwrite fields you've already filled.</p>
                    </div>
                </div>
                
                <button id="submit-btn" type="submit" style="display: none;" data-i18n="fill_my_form">Fill My Form</button>
            </form>
            <p id="status" class="helper" role="status"></p>
            <!-- Debug/Status area for Analyze PDF -->
            <div id="analyze-debug" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; font-size: 0.85rem; font-family: monospace;">
                <div><strong>Debug:</strong></div>
                <div id="analyze-debug-status"></div>
            </div>
            <!-- Visible Debug Panel (not DevTools) -->
            <div id="debug-panel" style="position: fixed; bottom: 20px; right: 20px; background: #1a1a1a; color: #0f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 11px; max-width: 400px; max-height: 300px; overflow-y: auto; z-index: 10000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px;">
                    <strong style="color: #0f0;">Debug Panel</strong>
                    <button id="debug-panel-close" style="background: #333; color: #0f0; border: 1px solid #555; padding: 2px 8px; cursor: pointer; border-radius: 3px;">Ã—</button>
                </div>
                <div id="debug-panel-content"></div>
            </div>
        </section>
        
        <div id="preview-container" style="display: none;">
            <div class="card">
                <h3 data-i18n="preview">Preview</h3>
                <div class="preview-wrapper" id="preview-wrapper">
                    <div class="preview-controls">
                        <button id="fullscreen-btn" type="button" data-i18n="fullscreen" title="Fullscreen">â›¶ <span data-i18n="fullscreen">Fullscreen</span></button>
                    </div>
                <iframe id="preview-iframe" src="" title="PDF Preview"></iframe>
                <div id="preview-fallback" class="preview-fallback" style="display: none;">
                        <p data-i18n="preview_fallback">Your browser may not support inline PDF preview.</p>
                        <p><a id="preview-link" href="" target="_blank" data-i18n="open_preview_new_tab">Open preview in new tab</a></p>
                    </div>
                </div>
                <div class="preview-actions">
                    <button id="download-btn" type="button" data-i18n="download_pdf">Download PDF</button>
                    <button id="edit-ai-btn" type="button" style="background: #059669;" data-i18n="edit_fix_ai">Edit & Fix with AI</button>
                </div>
                
                <div id="ai-fix-container" style="display: none;">
                    <div class="ai-fix-section">
                        <h3 data-i18n="tell_ai_fix">Tell AI what to fix</h3>
                        <label for="ai_feedback" data-i18n="feedback">Feedback</label>
                        <textarea id="ai_feedback" rows="3" data-i18n-placeholder="feedback_placeholder" placeholder="Examples:&#10;- Change the address to 123 Main St&#10;- Remove notes section&#10;- Correct email typo&#10;- Make the name uppercase"></textarea>
                        <button id="apply-ai-fix-btn" type="button" style="margin-top: 0.5rem; background: #059669;" data-i18n="apply_ai_fix">Apply AI Fix</button>
                    </div>
                </div>
            </div>
        </div>
                </div>
        <section class="pricing" id="pricing">
            <div class="pricing-tier">
                <div class="pricing-title">
                    <h2 data-i18n="free">Free</h2>
                    <span class="price" data-i18n="price_free">$0</span>
                </div>
                <ul>
                    <li data-i18n="free_feature_1">1 filled document per day</li>
                    <li data-i18n="free_feature_2">Footer watermark on each page</li>
                    <li data-i18n="free_feature_3">No signup required</li>
                </ul>
            </div>
            <div class="pricing-tier">
                <div class="pricing-title">
                    <h2 data-i18n="pro">Pro</h2>
                    <span class="price" data-i18n="price_pro">$19 / month</span>
                </div>
                <ul>
                    <li data-i18n="pro_feature_1">Unlimited PDF fills</li>
                    <li data-i18n="pro_feature_2">No watermark</li>
                    <li data-i18n="pro_feature_3">Priority rendering pipeline</li>
                </ul>
                <form id="upgrade-form" action="/create-checkout-session" method="post">
                    <button type="submit" id="upgrade-btn" data-i18n="upgrade_to_pro">Upgrade to Pro</button>
                </form>
            </div>
        </section>
        
        <!-- Pro Status Section (shown only for Pro users) -->
        <section id="pro-status-section" style="display: none; text-align: center; padding: 2rem; margin: 2rem 0;">
            <h2 style="color: var(--primary);">You are Pro âœ…</h2>
            <p style="color: var(--text-muted);">Enjoy unlimited PDF fills and no watermarks.</p>
        </section>
        
        <!-- Profiles Section (minimal, for scroll target) -->
        <section id="profiles-section" style="padding: 2rem 0; margin: 2rem 0; min-height: 200px;">
            <!-- Minimal section for Profiles menu item scroll target -->
        </section>
            </div>
    </main>
    </div>
    <!-- Sign In Modal -->
    <div id="signInModal" class="login-modal">
        <div class="login-modal-content">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link</p>
            <input type="email" id="signInEmail" placeholder="your@email.com" autocomplete="email">
            <button type="button" id="sendMagicBtn" class="primary">Send magic link</button>
            <button type="button" id="closeSignInBtn" class="secondary">Cancel</button>
            <div id="sign-in-status"></div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal" class="login-modal">
        <div id="profileModalContent" class="login-modal-content">
            <h3>Profile Settings</h3>
            <div id="profileStatus" style="min-height: 1.5rem; margin-bottom: 1rem; padding: 0.5rem; border-radius: 4px; display: block;"></div>
            
            <!-- Account Info Section -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">Account Information</h4>
                <div style="margin-bottom: 0.75rem;">
                    <label for="profileEmailCurrent" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">Email</label>
                    <input type="email" id="profileEmailCurrent" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #0f172a; background: #f5f5f5;">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">You can change your email once every 7 days.</p>
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <label for="profileEmailNew" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">New Email</label>
                    <input type="email" id="profileEmailNew" placeholder="Enter new email" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #0f172a; background: #fff;">
                </div>
                <button type="button" id="saveEmailBtn" class="primary" style="width: 100%; margin-bottom: 0.75rem;">Save Email</button>
                <div style="margin-bottom: 0.75rem;">
                    <label for="profileFullName" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">Full Name</label>
                    <input type="text" id="profileFullName" placeholder="Enter your full name" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <label for="profilePhone" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">Phone (Optional)</label>
                    <input type="tel" id="profilePhone" placeholder="Enter your phone number" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="button" id="saveProfileBtn" class="primary" style="width: 100%;">Save Changes</button>
            </div>
            
            <!-- Plan Status Section -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                <h4 style="margin-bottom: 0.75rem;">Plan Status</h4>
                <p id="profilePlanStatus" style="font-weight: 600; color: var(--primary);">â€”</p>
            </div>
            
            <!-- Plan Actions Section -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">Plan Actions</h4>
                <div id="profile-plan-actions">
                    <button type="button" id="manageSubscriptionBtn" style="display: none;" class="primary" style="width: 100%; margin-bottom: 0.5rem;">Manage Subscription</button>
                    <button type="button" id="upgradeToProBtn" style="display: none;" class="primary" style="width: 100%; margin-bottom: 0.5rem;">Upgrade to Pro</button>
                </div>
            </div>
            
            <!-- Sticky footer with Close button -->
            <div style="position: sticky; bottom: 0; background: var(--surface); padding-top: 12px; margin-top: 1rem; border-top: 1px solid var(--border);">
                <button type="button" id="closeProfileBtn" class="secondary" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>
    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fullscreen-modal" hidden>
        <div class="fullscreen-header">
            <h3 data-i18n="preview">Preview</h3>
            <button id="fullscreen-close-btn" class="fullscreen-close" data-i18n="close">Close (ESC)</button>
        </div>
        <div class="fullscreen-iframe-container">
            <iframe id="fullscreen-iframe" class="fullscreen-iframe" src="" title="PDF Preview Fullscreen"></iframe>
        </div>
    </div>
    <script type="module">
        // Import i18n module
        import { initI18n, setLocale, t, updatePageTranslations, getCurrentLocale, LANGUAGES, getLanguageByCode } from '/static/i18n/i18n.js';
        
        // Language picker UI
        const langPickerBtn = document.getElementById('lang-picker-btn');
        const langPickerDropdown = document.getElementById('lang-picker-dropdown');
        const langPickerList = document.getElementById('lang-picker-list');
        const langPickerSearch = document.getElementById('lang-picker-search');
        const langPickerFlag = document.getElementById('lang-picker-flag');
        const langPickerText = document.getElementById('lang-picker-text');
        
        let filteredLanguages = [...LANGUAGES];
        
        // Render language list
        function renderLanguageList(languages = LANGUAGES) {
            langPickerList.innerHTML = '';
            const currentLocale = getCurrentLocale();
            
            languages.forEach(lang => {
                const item = document.createElement('button');
                item.className = 'lang-picker-item';
                item.setAttribute('role', 'option');
                item.setAttribute('aria-selected', lang.code === currentLocale);
                if (lang.code === currentLocale) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <span class="flag">${lang.flag}</span>
                    <div class="names">
                        <span class="native-name">${lang.nativeName}</span>
                        ${lang.englishName !== lang.nativeName ? `<span class="english-name">${lang.englishName}</span>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    selectLanguage(lang.code);
                });
                
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectLanguage(lang.code);
                    }
                });
                
                langPickerList.appendChild(item);
            });
        }
        
        // Select language
        async function selectLanguage(localeCode) {
            setLocale(localeCode);
            await initI18n(localeCode);
            updatePageTranslations();
            updateLanguagePickerButton();
            closeLanguagePicker();
            
            // Update cookie via backend
            try {
                const formData = new FormData();
                formData.append('lang', localeCode);
                await fetch('/set-language', {
                    method: 'POST',
                    body: formData
                });
            } catch (err) {
                console.warn('Failed to update language cookie:', err);
            }
        }
        
        // Update language picker button
        function updateLanguagePickerButton() {
            const currentLang = getLanguageByCode(getCurrentLocale());
            if (currentLang) {
                langPickerFlag.textContent = currentLang.flag;
                langPickerText.textContent = currentLang.nativeName;
            }
        }
        
        // Toggle language picker
        function toggleLanguagePicker() {
            const isOpen = langPickerDropdown.classList.contains('open');
            if (isOpen) {
                closeLanguagePicker();
            } else {
                openLanguagePicker();
            }
        }
        
        function openLanguagePicker() {
            langPickerDropdown.classList.add('open');
            langPickerBtn.setAttribute('aria-expanded', 'true');
            langPickerSearch.focus();
            renderLanguageList(filteredLanguages);
        }
        
        function closeLanguagePicker() {
            langPickerDropdown.classList.remove('open');
            langPickerBtn.setAttribute('aria-expanded', 'false');
            langPickerSearch.value = '';
            filteredLanguages = [...LANGUAGES];
        }
        
        // Search languages
        langPickerSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (!query) {
                filteredLanguages = [...LANGUAGES];
            } else {
                filteredLanguages = LANGUAGES.filter(lang => 
                    lang.nativeName.toLowerCase().includes(query) ||
                    lang.englishName.toLowerCase().includes(query) ||
                    lang.code.toLowerCase().includes(query)
                );
            }
            renderLanguageList(filteredLanguages);
        });
        
        // Event listeners
        langPickerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleLanguagePicker();
        });
        
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!langPickerBtn.contains(e.target) && !langPickerDropdown.contains(e.target)) {
                closeLanguagePicker();
            }
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && langPickerDropdown.classList.contains('open')) {
                closeLanguagePicker();
                langPickerBtn.focus();
            }
        });
        
        // Initialize i18n and language picker
        (async () => {
            const defaultLang = '{{ default_lang }}' || null;
            await initI18n(defaultLang);
            updatePageTranslations();
            updateLanguagePickerButton();
            renderLanguageList();
            
            // Update search placeholder after translations load
            if (langPickerSearch) {
                langPickerSearch.placeholder = t('search_language');
            }
        })();
        
        // Export t function globally for use in other scripts
        window.t = t;
        window.updatePageTranslations = updatePageTranslations;
    </script>
    <script>
        // Safe translation fallback - must be defined at the very top before any handlers use it
        if (typeof window.t !== 'function') {
            window.t = function(k) { return k; }; // Minimal fallback
            window.t = function(key, vars) {
                // If vars is provided, interpolate {key} patterns
                if (vars && typeof vars === 'object') {
                    let result = key;
                    for (const [k, v] of Object.entries(vars)) {
                        result = result.replace(new RegExp(`\\{${k}\\}`, 'g'), String(v || ''));
                    }
                    return result;
                }
                // Return key as-is if no translation available
                return key;
            };
        }
        
        // Debug panel functions (available globally)
        function updateDebugPanel(message) {
            const panel = document.getElementById('debug-panel');
            const content = document.getElementById('debug-panel-content');
            if (panel && content) {
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.style.marginBottom = '4px';
                entry.style.color = '#0f0';
                entry.textContent = `[${timestamp}] ${message}`;
                content.appendChild(entry);
                panel.style.display = 'block';
                // Auto-scroll to bottom
                panel.scrollTop = panel.scrollHeight;
                // Keep last 50 entries
                while (content.children.length > 50) {
                    content.removeChild(content.firstChild);
                }
            }
        }
        
        // Wrap all main script in DOMContentLoaded to ensure DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugPanel('DOMContentLoaded fired');
        
        // Global error handler - show errors as toast and banner
        function showErrorBanner(message) {
            // Remove existing banner
            const existingBanner = document.getElementById('error-banner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            // Create error banner at bottom-left
            const banner = document.createElement('div');
            banner.id = 'error-banner';
            banner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: var(--error);
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                max-width: 400px;
                font-size: 13px;
                line-height: 1.4;
                word-wrap: break-word;
            `;
            banner.textContent = message.length > 200 ? message.substring(0, 200) + '...' : message;
            document.body.appendChild(banner);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (banner.parentNode) {
                    banner.style.opacity = '0';
                    banner.style.transition = 'opacity 0.3s';
                    setTimeout(() => banner.remove(), 300);
                }
            }, 10000);
        }
        
        // Catch unhandled errors
        window.addEventListener('error', (event) => {
            const message = event.message || 'Unknown error';
            const truncated = message.length > 200 ? message.substring(0, 200) + '...' : message;
            console.error('Unhandled error:', event.error || message);
            if (typeof showToast === 'function') {
                showToast('Error: ' + truncated, 'error');
            }
            showErrorBanner('JS Error: ' + truncated);
        });
        
        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            const message = event.reason?.message || String(event.reason) || 'Promise rejected';
            const truncated = message.length > 200 ? message.substring(0, 200) + '...' : message;
            console.error('Unhandled rejection:', event.reason);
            if (typeof showToast === 'function') {
                showToast('Error: ' + truncated, 'error');
            }
            showErrorBanner('Promise Error: ' + truncated);
        });
        
        // Authentication state
        let currentPdfHash = null;
        let userProfiles = [];
        
        // App configuration
        let appConfig = {
            stripeEnabled: false,
            openaiEnabled: false,
            env: 'dev'
        };
        
        // Auth UI elements - verify all required elements exist
        const authLoggedOut = document.getElementById('auth-logged-out');
        const authLoggedIn = document.getElementById('auth-logged-in');
        const userEmailEl = document.getElementById('user-email');
        const signInBtn = document.getElementById('sign-in-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const signInModal = document.getElementById('sign-in-modal');
        const signInEmailInput = document.getElementById('sign-in-email');
        const sendMagicLinkBtn = document.getElementById('send-magic-link-btn');
        const closeSignInModalBtn = document.getElementById('close-sign-in-modal');
        const signInStatus = document.getElementById('sign-in-status');
        
        // Verify required elements exist - show visible error if missing
        const requiredElements = {
            'sign-in-btn': signInBtn,
            'sign-in-modal': signInModal,
            'sign-in-email': signInEmailInput,
            'send-magic-link-btn': sendMagicLinkBtn,
            'close-sign-in-modal': closeSignInModalBtn
        };
        
        for (const [id, element] of Object.entries(requiredElements)) {
            if (!element) {
                const errorMsg = `UI init error: missing element ${id}`;
                console.error(errorMsg);
                updateDebugPanel(`ERROR: ${errorMsg}`);
                if (typeof showToast === 'function') {
                    showToast(errorMsg, 'error');
                }
                showErrorBanner(errorMsg);
            }
        }
        
        // Profile UI elements
        const profileSelectorContainer = document.getElementById('profile-selector-container');
        const profileSelect = document.getElementById('profile-select');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    authState = {
                        authenticated: data.authenticated || false,
                        email: data.email || null,
                        isPro: data.is_pro || data.isPro || false,
                        plan: data.plan || (data.is_pro || data.isPro ? 'pro' : 'free')
                    };
                    updateAuthUI();
                    if (authState.authenticated) {
                        loadUserProfiles();
                    }
                }
            } catch (err) {
                console.warn('Failed to check auth status:', err);
                authState.authenticated = false;
                updateAuthUI();
            }
        }
        
        // Update auth UI
        function updateAuthUI() {
            const planBadgeEl = document.getElementById('plan-badge');
            if (authState.authenticated && authState.email) {
                // User is logged in
                if (authLoggedOut) authLoggedOut.style.display = 'none';
                if (authLoggedIn) {
                    authLoggedIn.style.display = 'block';
                    if (userEmailEl) userEmailEl.textContent = authState.email;
                    // Show plan badge
                    if (planBadgeEl) {
                        const plan = authState.plan || (authState.isPro ? 'pro' : 'free');
                        planBadgeEl.textContent = plan === 'pro' ? 'Pro' : 'Free';
                        planBadgeEl.className = 'plan-badge ' + (plan === 'pro' ? 'pro' : 'free');
                        planBadgeEl.style.display = 'inline-block';
                    }
                }
                if (profileSelectorContainer && userProfiles.length > 0) {
                    profileSelectorContainer.style.display = 'block';
                }
            } else {
                // User is not logged in - show sign in button
                if (authLoggedOut) authLoggedOut.style.display = 'block';
                if (authLoggedIn) authLoggedIn.style.display = 'none';
                if (planBadgeEl) planBadgeEl.style.display = 'none';
                if (profileSelectorContainer) profileSelectorContainer.style.display = 'none';
                userProfiles = [];
            }
        }
        
        // Load user profiles
        async function loadUserProfiles() {
            if (!authState.authenticated) return;
            
            try {
                const response = await fetch('/api/profiles', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    userProfiles = data.profiles || [];
                    updateProfileSelector();
                }
            } catch (err) {
                console.error('Failed to load profiles:', err);
            }
        }
        
        // Update profile selector dropdown
        function updateProfileSelector() {
            profileSelect.innerHTML = '<option value="">-- Select a profile --</option>';
            userProfiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name;
                profileSelect.appendChild(option);
            });
            
            if (userProfiles.length > 0 || authState.authenticated) {
                profileSelectorContainer.style.display = 'block';
            }
            
            // Show save button if user is authenticated, Pro check determines if enabled
            if (authState.authenticated) {
                saveProfileBtn.style.display = 'block';
                if (authState.isPro) {
                    saveProfileBtn.disabled = false;
                    saveProfileBtn.textContent = 'Save Current Fields as Profile';
                    saveProfileBtn.title = '';
                    saveProfileBtn.style.opacity = '1';
                    saveProfileBtn.style.cursor = 'pointer';
                } else {
                    saveProfileBtn.disabled = true;
                    saveProfileBtn.textContent = 'Upgrade to Pro to save profiles';
                    saveProfileBtn.title = 'Pro subscription required to save profiles';
                    saveProfileBtn.style.opacity = '0.7';
                    saveProfileBtn.style.cursor = 'not-allowed';
                }
            }
        }
        
        // Apply profile to form fields
        async function applyProfile(profileId) {
            if (!currentFields.length || !currentPdfHash) {
                setStatus('Please analyze a PDF first.', true);
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('profile_id', profileId);
                formData.append('pdf_hash', currentPdfHash);
                formData.append('fields_json', JSON.stringify(currentFields));
                
                const response = await fetch('/api/profiles/apply', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to apply profile');
                }
                
                const data = await response.json();
                const mappedData = data.mapped_data || {};
                
                // Fill form fields with mapped data
                let filledCount = 0;
                currentFields.forEach(field => {
                    const fieldName = field.name;
                    const input = document.getElementById(`field_${fieldName}`);
                    if (input && mappedData[fieldName] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = mappedData[fieldName] === true || mappedData[fieldName] === 'true';
                        } else {
                            input.value = String(mappedData[fieldName]);
                        }
                        saveFieldValue(fieldName, input.value || (input.checked ? 'true' : ''));
                        filledCount++;
                    }
                });
                
                if (filledCount > 0) {
                    setStatus(`Applied profile: filled ${filledCount} field${filledCount !== 1 ? 's' : ''}.`, false, true);
                } else {
                    setStatus('Profile applied but no matching fields found.', true);
                }
            } catch (err) {
                setStatus('Failed to apply profile: ' + err.message, true);
            }
        }
        
        // Save current fields as profile
        async function saveCurrentProfile() {
            if (!authState.authenticated) {
                setStatus('Please sign in to save profiles.', true);
                return;
            }
            
            // Check if user is Pro
            if (!authState.isPro) {
                setStatus('Saving profiles requires a Pro subscription. Please upgrade to Pro.', true);
                // Scroll to pricing section
                const pricingSection = document.getElementById('pricing');
                if (pricingSection) {
                    pricingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                return;
            }
            
            if (!currentFields.length) {
                setStatus('Please analyze a PDF and fill some fields first.', true);
                return;
            }
            
            const profileName = prompt('Enter a name for this profile:');
            if (!profileName || !profileName.trim()) {
                return;
            }
            
            // Collect current field values
            const profileData = {};
            currentFields.forEach(field => {
                const input = document.getElementById(`field_${field.name}`);
                if (input) {
                    if (input.type === 'checkbox') {
                        if (input.checked) {
                            profileData[field.name] = true;
                        }
                    } else {
                        const val = input.value.trim();
                        if (val) {
                            profileData[field.name] = val;
                        }
                    }
                }
            });
            
            if (Object.keys(profileData).length === 0) {
                setStatus('No field values to save.', true);
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('name', profileName.trim());
                formData.append('data', JSON.stringify(profileData));
                
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to save profile');
                }
                
                setStatus('Profile saved successfully!', false, true);
                await loadUserProfiles();
            } catch (err) {
                setStatus('Failed to save profile: ' + err.message, true);
            }
        }
        
        // Auth event listeners - attach only if elements exist
        let signInHandlerAttached = false;
        if (signInBtn && signInModal && signInEmailInput) {
            signInBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                updateDebugPanel('Sign In clicked');
                try {
                    signInModal.classList.add('active');
                    signInEmailInput.focus();
                    if (signInStatus) signInStatus.innerHTML = '';
                    updateDebugPanel('Modal opened');
                } catch (err) {
                    const errorMsg = `Failed to open modal: ${err.message}`;
                    console.error(errorMsg, err);
                    updateDebugPanel(`ERROR: ${errorMsg}`);
                    if (typeof showToast === 'function') {
                        showToast(errorMsg, 'error');
                    }
                }
            });
            signInHandlerAttached = true;
            updateDebugPanel(`Sign In handler attached: ${signInHandlerAttached}`);
        } else {
            const errorMsg = 'Cannot attach Sign In handler: missing required elements';
            console.error(errorMsg);
            updateDebugPanel(`ERROR: ${errorMsg}`);
            if (typeof showToast === 'function') {
                showToast(errorMsg, 'error');
            }
        }
        
        if (closeSignInModalBtn && signInModal && signInEmailInput) {
            closeSignInModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                signInModal.classList.remove('active');
                if (signInStatus) signInStatus.innerHTML = '';
                signInEmailInput.value = '';
                updateDebugPanel('Modal closed');
            });
        }
        
        // Close modal on outside click
        if (signInModal) {
            signInModal.addEventListener('click', (e) => {
            if (e.target === signInModal) {
                signInModal.classList.remove('active');
                signInStatus.innerHTML = '';
                signInEmailInput.value = '';
            }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && signInModal?.classList.contains('active')) {
                signInModal.classList.remove('active');
                signInStatus.innerHTML = '';
                signInEmailInput.value = '';
            }
        });
        
        sendMagicLinkBtn?.addEventListener('click', async (e) => {
            try {
                // Prevent any default form submission behavior
                e.preventDefault();
                e.stopPropagation();
                
                updateDebugPanel('Sign-in click fired');
                
                const email = signInEmailInput.value.trim();
                if (!email) {
                    signInStatus.innerHTML = '<div class="login-status error">Please enter an email address.</div>';
                    return;
                }
                
                // Validate email format
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                    signInStatus.innerHTML = '<div class="login-status error">Please enter a valid email address.</div>';
                    return;
                }
                
                sendMagicLinkBtn.disabled = true;
                sendMagicLinkBtn.textContent = 'Sending...';
                signInStatus.innerHTML = '';
                
                // Log request for debugging
                console.log('Sign in request:', { email, endpoint: '/auth/send-magic-link', method: 'POST' });
                updateDebugPanel(`POST /auth/send-magic-link (email: ${email})`);
                
                try {
                const formData = new FormData();
                formData.append('email', email);
                
                const response = await fetch('/auth/send-magic-link', {
                    method: 'POST',
                    body: formData
                });
                
                updateDebugPanel(`Response: ${response.status} ${response.statusText}`);
                
                // Read response body
                const contentType = response.headers.get('content-type') || '';
                let responseData = null;
                let responseText = '';
                
                try {
                    if (contentType.includes('application/json')) {
                        responseData = await response.json();
                        responseText = JSON.stringify(responseData);
                    } else {
                        responseText = await response.text();
                        try {
                            responseData = JSON.parse(responseText);
                        } catch {
                            // Not JSON, keep as text
                        }
                    }
                } catch (readErr) {
                    console.error('Failed to read response:', readErr);
                    responseText = 'Could not read response body';
                }
                
                // Log response for debugging
                console.log('Sign in response:', {
                    status: response.status,
                    statusText: response.statusText,
                    body: responseText || 'Could not read response body'
                });
                
                if (response.ok) {
                    // Success - show clear message
                    const message = responseData?.message || 'Check your email for the magic link.';
                    let statusHtml = `<div class="login-status success">${message}</div>`;
                    
                    // Show dev link if available (dev mode or if magicLink is provided)
                    const magicLink = responseData?.magicLink || responseData?.dev_link;
                    if (magicLink && appConfig.env === 'dev') {
                        statusHtml += `
                            <div class="dev-link">
                                <strong>Development mode:</strong><br>
                                <a href="${magicLink}" target="_blank">${magicLink}</a>
                                <button onclick="navigator.clipboard.writeText('${magicLink}')" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; background: var(--surface-2); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">Copy link</button>
                            </div>
                        `;
                    }
                    
                    signInStatus.innerHTML = statusHtml;
                    signInEmailInput.value = '';
                } else if (response.status === 503) {
                    // Service Unavailable - SMTP not configured or send failed
                    const errorDetail = responseData?.detail || 'Email service is not available. Please try again later.';
                    signInStatus.innerHTML = `<div class="login-status error">${errorDetail}</div>`;
                } else {
                    // Other errors
                    const errorDetail = responseData?.detail || 'Failed to send magic link. Please try again.';
                    signInStatus.innerHTML = `<div class="login-status error">${errorDetail}</div>`;
                }
                } catch (err) {
                    const errorMsg = err.message || 'Failed to send magic link. Please try again.';
                    signInStatus.innerHTML = `<div class="login-status error">Error: ${errorMsg}</div>`;
                    if (typeof showToast === 'function') {
                        showToast('Sign-in error: ' + errorMsg, 'error');
                    }
                    console.error('Sign-in error:', err);
                } finally {
                    sendMagicLinkBtn.disabled = false;
                    sendMagicLinkBtn.textContent = 'Send magic link';
                }
            } catch (err) {
                // Outer catch for any unexpected errors
                const errorMsg = err.message || 'Unexpected error. Please try again.';
                if (typeof showToast === 'function') {
                    showToast('Sign-in error: ' + errorMsg, 'error');
                }
                console.error('Unexpected sign-in error:', err);
            }
        });
        
        // Allow Enter key to submit
        signInEmailInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendMagicLinkBtn.disabled) {
                sendMagicLinkBtn.click();
            }
        });
        
        // User dropdown toggle
        userPill?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = userDropdown.classList.contains('open');
            if (isOpen) {
                userDropdown.classList.remove('open');
                userPill.classList.remove('open');
            } else {
                userDropdown.classList.add('open');
                userPill.classList.add('open');
            }
        });
        
        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (userDropdown && userPill && !userDropdown.contains(e.target) && !userPill.contains(e.target)) {
                userDropdown.classList.remove('open');
                userPill.classList.remove('open');
            }
        });
        
        // Profiles menu item
        profilesMenuItem?.addEventListener('click', () => {
            const pricingSection = document.getElementById('pricing');
            if (pricingSection) {
                pricingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            userDropdown.classList.remove('open');
            userPill.classList.remove('open');
        });
        
        // Logout
        logoutMenuItem?.addEventListener('click', async () => {
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
                authState = { authenticated: false, email: null, isPro: false };
                updateAuthUI();
                setStatus('Logged out successfully.', false, true);
            } catch (err) {
                console.error('Logout error:', err);
                setStatus('Failed to logout. Please try again.', true);
            }
        });
        
        // Profile event listeners
        profileSelect?.addEventListener('change', (e) => {
            if (e.target.value) {
                applyProfile(e.target.value);
            }
        });
        
        saveProfileBtn?.addEventListener('click', saveCurrentProfile);
        
        // Load app configuration
        async function loadAppConfig() {
            try {
                const response = await fetch('/api/config', { credentials: 'include' });
                if (response.ok) {
                    appConfig = await response.json();
                    updateUpgradeButton();
                }
            } catch (err) {
                console.warn('Failed to load app config:', err);
            }
        }
        
        // Update upgrade button based on Stripe availability
        function updateUpgradeButton() {
            const upgradeBtn = document.getElementById('upgrade-btn');
            const upgradeForm = document.getElementById('upgrade-form');
            
            if (!upgradeBtn || !upgradeForm) return;
            
            if (!appConfig.stripeEnabled) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'Payments disabled in this environment';
                upgradeBtn.title = 'Payments are not configured in this environment';
                upgradeBtn.style.opacity = '0.7';
                upgradeBtn.style.cursor = 'not-allowed';
            } else {
                upgradeBtn.disabled = false;
                upgradeBtn.textContent = 'Upgrade to Pro';
                upgradeBtn.title = '';
                upgradeBtn.style.opacity = '1';
                upgradeBtn.style.cursor = 'pointer';
            }
        }
        
        // Handle upgrade form submission
        const upgradeForm = document.getElementById('upgrade-form');
        upgradeForm?.addEventListener('submit', async (e) => {
            if (!appConfig.stripeEnabled) {
                e.preventDefault();
                setStatus('Payments are not configured in this environment.', true);
                return;
            }
            
            // Let the form submit normally if Stripe is enabled
        });
        
        // Initialize: Load config and check auth
        (async () => {
            await loadAppConfig();
            await checkAuth();
            
            // Check for auth success/error in URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auth_success') === '1') {
                // Re-check auth status after successful login
                await checkAuth();
                // Show visible toast
                showToast('Signed in!', 'success');
                // Remove query param from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            } else if (urlParams.get('auth_error')) {
                const errorType = urlParams.get('auth_error');
                let errorMsg = 'Sign-in failed. Please try again.';
                if (errorType === 'invalid_token') {
                    errorMsg = 'Invalid or expired sign-in link. Please request a new one.';
                } else if (errorType === 'db_unavailable') {
                    errorMsg = 'Service temporarily unavailable. Please try again later.';
                }
                setStatus(errorMsg, true);
                showToast(errorMsg, 'error');
                // Remove query param from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }
        })();
        
        const form = document.getElementById('upload-form');
        const statusEl = document.getElementById('status');
        const submitBtn = document.getElementById('submit-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const fieldsContainer = document.getElementById('fields-container');
        const fieldsList = document.getElementById('fields-list');
        const fieldsSummary = document.getElementById('fields-summary');
        const pdfFileInput = document.getElementById('pdf_file');
        const aiTextArea = document.getElementById('ai_text');
        const aiExtractBtn = document.getElementById('ai-extract-btn');
        const previewContainer = document.getElementById('preview-container');
        const previewIframe = document.getElementById('preview-iframe');
        const downloadBtn = document.getElementById('download-btn');
        const editAiBtn = document.getElementById('edit-ai-btn');
        const aiFixContainer = document.getElementById('ai-fix-container');
        const aiFeedback = document.getElementById('ai_feedback');
        const applyAiFixBtn = document.getElementById('apply-ai-fix-btn');
        const previewFallback = document.getElementById('preview-fallback');
        const previewLink = document.getElementById('preview-link');
        const fullscreenModal = document.getElementById('fullscreen-modal');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const fullscreenIframe = document.getElementById('fullscreen-iframe');
        const mainContentGrid = document.getElementById('main-content-grid');
        let currentFields = [];
        let currentFileId = null;
        let currentPdfFile = null;
        let previewLoadTimeout = null;
        let currentPreviewUrl = null;

        // Format field name to readable label
        function formatFieldLabel(name) {
            return name
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ')
                .trim();
        }

        // Get placeholder for common field types
        function getPlaceholder(fieldName) {
            const lower = fieldName.toLowerCase();
            if (lower.includes('email')) return 'example@email.com';
            if (lower.includes('phone') || lower.includes('tel')) return '(555) 123-4567';
            if (lower.includes('zip') || lower.includes('postal')) return '12345';
            if (lower.includes('date') || lower.includes('dob')) return 'MM/DD/YYYY';
            if (lower.includes('ssn')) return 'XXX-XX-XXXX';
            return '';
        }

        // Load saved field values from localStorage
        function loadFieldValue(fieldName) {
            try {
                const saved = localStorage.getItem(`ffai_field_${fieldName}`);
                return saved !== null ? saved : '';
            } catch {
                return '';
            }
        }

        // Save field value to localStorage
        function saveFieldValue(fieldName, value) {
            try {
                if (value) {
                    localStorage.setItem(`ffai_field_${fieldName}`, value);
                } else {
                    localStorage.removeItem(`ffai_field_${fieldName}`);
                }
            } catch {}
        }

        function setStatus(message, isError = false, isSuccess = false) {
            statusEl.textContent = message || '';
            statusEl.className = 'helper';
            if (isError) {
                statusEl.classList.add('error');
            } else if (isSuccess) {
                statusEl.classList.add('success');
            } else {
                statusEl.style.color = '#64748b';
            }
        }
        
        // Toast notification system for prominent error/success messages
        function showToast(message, type = 'error') {
            // Remove existing toast if any
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? 'var(--error)' : 'var(--success)'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 14px;
                line-height: 1.5;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            if (!document.getElementById('toast-animations')) {
                style.id = 'toast-animations';
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds (or 8 seconds for errors)
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, type === 'error' ? 8000 : 5000);
        }

        // Show query-based messages from redirects
        const params = new URLSearchParams(window.location.search || '');
        if (params.get('upgraded') === '1') {
            setStatus(t('errors.upgraded'), false, true);
        } else if (params.get('canceled') === '1') {
            setStatus(t('errors.canceled'), true);
        }

        // Update analyze button state based on file selection and auth
        function updateAnalyzeButtonState() {
            const file = pdfFileInput.files[0];
            const hasFile = !!file;
            const isAuthenticated = authState.authenticated;
            
            if (!hasFile) {
                analyzeBtn.disabled = true;
                analyzeBtn.title = t('errors.select_pdf_first');
            } else if (!isAuthenticated) {
                analyzeBtn.disabled = false;
                analyzeBtn.title = 'Sign in recommended for better experience';
            } else {
                analyzeBtn.disabled = false;
                analyzeBtn.title = '';
            }
        }
        
        // Update button state when file is selected
        pdfFileInput.addEventListener('change', updateAnalyzeButtonState);
        
        // Update button state when auth state changes
        const originalUpdateAuthUI = updateAuthUI;
        updateAuthUI = function() {
            originalUpdateAuthUI();
            updateAnalyzeButtonState();
        };
        
        // Initialize button state
        updateAnalyzeButtonState();
        
        // Debug area elements
        const analyzeDebug = document.getElementById('analyze-debug');
        const analyzeDebugStatus = document.getElementById('analyze-debug-status');
        
        function updateAnalyzeDebug(message) {
            if (analyzeDebug && analyzeDebugStatus) {
                analyzeDebug.style.display = 'block';
                analyzeDebugStatus.textContent = message;
            }
        }
        
        // Analyze PDF button - ensure it's not inside a form that would submit
        analyzeBtn.addEventListener('click', async (e) => {
            try {
                // Prevent any form submission or default navigation
                e.preventDefault();
                e.stopPropagation();
                
                updateDebugPanel('Analyze PDF click fired');
                
            const file = pdfFileInput.files[0];
            if (!file) {
                    const msg = (typeof t === 'function' ? t('errors.select_pdf_first') : null) || 'Please select a PDF file first';
                    setStatus(msg, true);
                    showToast(msg, 'error');
                    updateDebugPanel('Error: No file selected');
                return;
            }

                // Log analyze click with file info
                console.log('Analyze clicked:', {
                    filename: file.name,
                    size: file.size,
                    type: file.type
                });
                
                updateDebugPanel(`POST /fields (file: ${file.name}, size: ${file.size})`);
                
                // Show debug status
                updateAnalyzeDebug('Analyze clicked - preparing request...');

                // Immediately show feedback and disable button
                setStatus('Uploading...', false);
                showToast('Uploading...', 'success');
            analyzeBtn.disabled = true;
                analyzeBtn.textContent = (typeof t === 'function' ? t('analyzing') : null) || 'Analyzing...';

            const formData = new FormData();
            formData.append('pdf_file', file);

            try {
                    updateAnalyzeDebug('Sending POST /fields...');
                    const response = await fetch('/fields', { 
                        method: 'POST', 
                        body: formData,
                        credentials: 'include'
                    });
                    
                    updateDebugPanel(`Response: ${response.status} ${response.statusText}`);
                    updateAnalyzeDebug(`POST /fields response: ${response.status} ${response.statusText}`);
                
                // Read response body exactly once based on content-type
                const contentType = response.headers.get('content-type') || '';
                let responseData = null;
                let responseText = '';
                
                    // Always log response status and text to console and debug area
                    try {
                    if (contentType.includes('application/json')) {
                            responseData = await response.json();
                            responseText = JSON.stringify(responseData);
                    } else {
                            responseText = await response.text();
                        }
                        console.log('Analyze PDF response:', response.status, responseText);
                        const responsePreview = responseText.substring(0, 200) + (responseText.length > 200 ? '...' : '');
                        updateDebugPanel(`Response body: ${responsePreview}`);
                        updateAnalyzeDebug(`POST /fields response: ${response.status} ${response.statusText}\nBody: ${responsePreview}`);
                    } catch (readErr) {
                        console.error('Failed to read response:', readErr);
                        responseText = 'Could not read response body';
                        updateAnalyzeDebug(`POST /fields response: ${response.status} ${response.statusText}\nError reading body: ${readErr.message}`);
                    }
                
                // Handle non-200 responses - show visible toast
                if (!response.ok) {
                    let detail = (typeof t === 'function' ? t('errors.failed_analyze') : null) || 'Failed to analyze PDF.';
                    
                    // Extract error message from response
                    if (responseData && responseData.detail) {
                        detail = responseData.detail;
                    } else if (responseText && !responseData) {
                        detail = responseText;
                    }
                    
                    // Map status codes to user-friendly messages
                    if (response.status === 401) {
                        detail = 'Not signed in. Please sign in first.';
                        showToast('Not signed in. Please sign in first.', 'error');
                        setStatus('Not signed in. Please sign in first.', true);
                    } else if (response.status === 403) {
                        detail = 'You do not have permission to analyze PDFs.';
                    } else if (response.status === 413) {
                        detail = 'File too large. Maximum size is 10MB.';
                    } else if (response.status === 422) {
                        detail = (typeof t === 'function' ? t('errors.no_form_fields') : null) || 'This PDF does not contain fillable form fields.';
                    } else if (response.status === 500) {
                        detail = 'Server error. Please try again later.';
                    }
                    
                    // Show visible toast on ANY non-200 response
                    setStatus(detail, true);
                    showToast(detail, 'error');
                    fieldsContainer.style.display = 'none';
                    submitBtn.style.display = 'none';
                    return;
                }

                // Success - render preview + fields
                if (!responseData) {
                    responseData = JSON.parse(responseText);
                }
                currentFields = responseData.fields || [];
                currentPdfHash = responseData.pdf_hash || null;
                
                if (currentFields.length === 0) {
                    const msg = (typeof t === 'function' ? t('no_fields_found') : null) || 'No fillable fields found in PDF';
                    setStatus(msg, true);
                    showToast(msg, 'error');
                    fieldsContainer.style.display = 'none';
                    submitBtn.style.display = 'none';
                } else {
                    // Success - render preview + fields
                    const count = currentFields.length;
                    console.log('Fields found:', count);
                    
                    // Show preview if preview_url is available
                    if (responseData.preview_url) {
                        const previewUrl = `${responseData.preview_url}?t=${Date.now()}`;
                        console.log('Setting preview iframe src:', previewUrl);
                        
                        // Set up fallback link
                        previewLink.href = responseData.preview_url;
                        previewLink.textContent = 'Open preview in new tab';
                        previewFallback.style.display = 'none';
                        
                        // Handle iframe load/error events
                        previewIframe.onload = () => {
                            console.log('Preview iframe loaded successfully');
                            if (previewLoadTimeout) {
                                clearTimeout(previewLoadTimeout);
                                previewLoadTimeout = null;
                            }
                            previewFallback.style.display = 'none';
                        };
                        previewIframe.onerror = () => {
                            console.error('Preview iframe failed to load');
                            previewFallback.style.display = 'block';
                        };
                        
                        // Set timeout to show fallback if iframe doesn't load within 5 seconds
                        previewLoadTimeout = setTimeout(() => {
                            console.warn('Preview iframe load timeout, showing fallback');
                            previewFallback.style.display = 'block';
                        }, 5000);
                        
                        // Set iframe src and show container
                        previewIframe.src = previewUrl;
                        previewContainer.style.display = 'block';
                        previewContainer.setAttribute('data-has-preview', 'true');
                        mainContentGrid.classList.add('has-preview');
                        aiFixContainer.style.display = 'none';
                    }
                    
                    // Render fields
                    renderFields(currentFields);
                    fieldsContainer.style.display = 'block';
                    submitBtn.style.display = 'block';
                    const summaryText = count === 1 
                        ? ((typeof t === 'function' ? t('fields_found', {count}) : null) || `Field found: ${count}`)
                        : ((typeof t === 'function' ? t('fields_found_plural', {count}) : null) || `Fields found: ${count}`);
                    fieldsSummary.textContent = summaryText;
                    setStatus(`Fields found: ${count}`, false, true);
                    showToast(`Fields found: ${count}`, 'success');
                }
            } catch (err) {
                console.error('Analyze PDF error:', err);
                const errorMessage = err.message || t('errors.failed_analyze') || 'Failed to analyze PDF. Please try again.';
                setStatus(errorMessage, true);
                showToast(errorMessage, 'error');
                fieldsContainer.style.display = 'none';
                submitBtn.style.display = 'none';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = t('analyze_pdf');
                updateAnalyzeButtonState();
            }
        });

        // AI Extract button
        aiExtractBtn.addEventListener('click', async () => {
            const userText = aiTextArea.value.trim();
            if (!userText) {
                setStatus(t('errors.enter_text_extract'), true);
                return;
            }

            if (currentFields.length === 0) {
                setStatus(t('errors.analyze_first'), true);
                return;
            }

            setStatus(t('extracting'));
            aiExtractBtn.disabled = true;
            aiExtractBtn.textContent = t('extracting');

            try {
                // Collect current field values to pass to AI (so it doesn't overwrite)
                const currentValues = {};
                currentFields.forEach(field => {
                    const input = document.getElementById(`field_${field.name}`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            if (input.checked) {
                                currentValues[field.name] = true;
                            }
                        } else {
                            const val = input.value.trim();
                            if (val) {
                                currentValues[field.name] = val;
                            }
                        }
                    }
                });

                const formData = new FormData();
                formData.append('fields_json', JSON.stringify(currentFields));
                formData.append('user_text', userText);
                formData.append('current_values', JSON.stringify(currentValues));

                const response = await fetch('/ai-extract', { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'include'
                });
                
                const contentType = response.headers.get('content-type') || '';
                
                if (!response.ok) {
                    let detail = t('errors.ai_extraction_failed');
                    if (contentType.includes('application/json')) {
                        const errorData = await response.json();
                        detail = errorData.detail || detail;
                    } else {
                        detail = await response.text();
                    }
                    throw new Error(detail);
                }

                const data = await response.json();
                const extracted = data.extracted || {};
                
                // Fill only empty fields with extracted values (AI won't overwrite)
                let filledCount = 0;
                currentFields.forEach(field => {
                    const fieldName = field.name;
                    const input = document.getElementById(`field_${field.name}`);
                    if (input && extracted[fieldName] !== undefined && extracted[fieldName] !== null && extracted[fieldName] !== '') {
                        // Only fill if field is currently empty
                        const isEmpty = input.type === 'checkbox' ? !input.checked : !input.value.trim();
                        if (isEmpty) {
                            if (input.type === 'checkbox') {
                                input.checked = extracted[fieldName] === true || extracted[fieldName] === 'true';
                            } else {
                                input.value = String(extracted[fieldName]);
                            }
                            saveFieldValue(fieldName, input.value || (input.checked ? 'true' : ''));
                            filledCount++;
                        }
                    }
                });

                if (filledCount > 0) {
                    const msg = filledCount === 1 ? t('errors.ai_filled_count', {count: filledCount}) : t('errors.ai_filled_count_plural', {count: filledCount});
                    setStatus(msg, false, true);
                } else {
                    setStatus(t('errors.ai_could_not_extract'), true);
                }
            } catch (err) {
                setStatus(err.message, true);
            } finally {
                aiExtractBtn.disabled = false;
                aiExtractBtn.textContent = t('auto_fill_ai');
            }
        });

        function renderFields(fields) {
            fieldsList.innerHTML = '';
            fields.forEach(field => {
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';
                
                const label = document.createElement('label');
                const labelText = formatFieldLabel(field.name);
                label.textContent = labelText;
                
                let input;
                const savedValue = loadFieldValue(field.name);
                const value = field.value || savedValue || '';
                const placeholder = getPlaceholder(field.name);

                if (field.type === 'checkbox') {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `field_${field.name}`;
                    checkbox.name = field.name;
                    checkbox.checked = value === true || value === 'true' || value === true;
                    checkbox.addEventListener('change', (e) => {
                        saveFieldValue(field.name, e.target.checked ? 'true' : '');
                    });
                    label.insertBefore(checkbox, label.firstChild);
                    fieldGroup.appendChild(label);
                } else if (field.type === 'choice' && field.options && field.options.length > 0) {
                    const select = document.createElement('select');
                    select.id = `field_${field.name}`;
                    select.name = field.name;
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select --';
                    const emptyOptionText = t('select');
                    emptyOption.textContent = emptyOptionText;
                    select.appendChild(emptyOption);
                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (opt === value) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    select.addEventListener('change', (e) => {
                        saveFieldValue(field.name, e.target.value);
                    });
                    label.appendChild(select);
                    fieldGroup.appendChild(label);
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.id = `field_${field.name}`;
                    input.name = field.name;
                    input.value = value;
                    if (placeholder) {
                        input.placeholder = placeholder;
                    }
                    input.addEventListener('input', (e) => {
                        saveFieldValue(field.name, e.target.value);
                    });
                    label.appendChild(input);
                    fieldGroup.appendChild(label);
                }
                
                fieldsList.appendChild(fieldGroup);
            });
        }

        // Store PDF file for AI corrections
        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                currentPdfFile = e.target.files[0];
                // Clear previous preview and hash when new file selected
                currentPdfHash = null;
                currentFileId = null;
                previewContainer.style.display = 'none';
                mainContentGrid.classList.remove('has-preview');
            }
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (currentFileId) {
                window.open(`/download/${currentFileId}`, '_blank');
            }
        });

        // Fullscreen functionality
        fullscreenBtn.addEventListener('click', () => {
            if (currentPreviewUrl) {
                fullscreenIframe.src = currentPreviewUrl;
                fullscreenModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });

        fullscreenCloseBtn.addEventListener('click', () => {
            fullscreenModal.classList.remove('active');
            document.body.style.overflow = '';
            fullscreenIframe.src = '';
        });

        // Close fullscreen on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && fullscreenModal.classList.contains('active')) {
                fullscreenModal.classList.remove('active');
                document.body.style.overflow = '';
                fullscreenIframe.src = '';
            }
        });

        // Edit with AI button
        editAiBtn.addEventListener('click', () => {
            aiFixContainer.style.display = aiFixContainer.style.display === 'none' ? 'block' : 'none';
        });

        // Apply AI Fix button
        applyAiFixBtn.addEventListener('click', async () => {
            const feedback = aiFeedback.value.trim();
            if (!feedback) {
                setStatus(t('errors.provide_feedback'), true);
                return;
            }

            if (!currentFileId) {
                setStatus(t('errors.no_preview'), true);
                return;
            }

            setStatus(t('processing'));
            applyAiFixBtn.disabled = true;
            applyAiFixBtn.innerHTML = `<span class="spinner"></span> ${t('processing')}`;

            try {
                // Collect current field values
                const currentValues = {};
                currentFields.forEach(field => {
                    const input = document.getElementById(`field_${field.name}`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            currentValues[field.name] = input.checked;
                        } else {
                            const val = input.value.trim();
                            if (val) {
                                currentValues[field.name] = val;
                            }
                        }
                    }
                });

                const formData = new FormData();
                formData.append('file_id', currentFileId);
                formData.append('fields_json', JSON.stringify(currentFields));
                formData.append('current_values', JSON.stringify(currentValues));
                formData.append('feedback', feedback);

                const response = await fetch('/ai-fix', { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'include'
                });
                
                const contentType = response.headers.get('content-type') || '';
                
                if (!response.ok) {
                    let detail = 'AI correction failed.';
                    if (contentType.includes('application/json')) {
                        const errorData = await response.json();
                        detail = errorData.detail || detail;
                    } else {
                        detail = await response.text();
                    }
                    throw new Error(detail);
                }

                const data = await response.json();
                console.log('AI fix success:', data);
                
                if (data.success) {
                    // Update form inputs with corrected values by fetching the updated field values
                    // We'll need to re-analyze or get updated values, but for now just refresh preview
                    // The form inputs will be updated when user makes another AI fix or manually edits
                    
                    // Refresh preview with cache-busting
                    currentPreviewUrl = `${data.preview_url}?t=${Date.now()}`;
                    console.log('Refreshing preview iframe:', currentPreviewUrl);
                    previewIframe.src = currentPreviewUrl;
                    aiFeedback.value = '';
                    aiFixContainer.style.display = 'none';
                    setStatus(`AI updated ${data.updated_fields.length} field${data.updated_fields.length !== 1 ? 's' : ''}. Preview refreshed.`, false, true);
                    
                    // Scroll to preview to show the update
                    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    throw new Error('AI correction failed.');
                }
            } catch (err) {
                setStatus(err.message, true);
            } finally {
                applyAiFixBtn.disabled = false;
                applyAiFixBtn.textContent = t('apply_ai_fix');
            }
        });

        // Form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            setStatus(t('processing'));
            submitBtn.disabled = true;
            submitBtn.textContent = t('processing');

            const formData = new FormData(form);
            
            // Collect field values from generated form
            const fieldsData = {};
            currentFields.forEach(field => {
                const input = document.getElementById(`field_${field.name}`);
                if (input) {
                    if (input.type === 'checkbox') {
                        fieldsData[field.name] = input.checked;
                    } else {
                        const val = input.value.trim();
                        if (val) {
                            fieldsData[field.name] = val;
                        }
                    }
                }
            });
            
            // Add fields_json if we have field data
            if (Object.keys(fieldsData).length > 0) {
                formData.append('fields_json', JSON.stringify(fieldsData));
            }
            
            try {
                const response = await fetch('/fill', { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'include'
                });
                
                // Read response body exactly once based on content-type
                const contentType = response.headers.get('content-type') || '';
                
                if (!response.ok) {
                    let detail = t('errors.something_wrong');
                    if (contentType.includes('application/json')) {
                        const errorData = await response.json();
                        detail = errorData.detail || detail;
                        // Translate common errors
                        if (errorData.detail) {
                            if (errorData.detail.includes('Daily free limit')) {
                                detail = t('errors.daily_limit_reached');
                            } else if (errorData.detail.includes('No form field values')) {
                                detail = t('errors.no_field_values');
                            }
                        }
                    } else {
                        detail = await response.text();
                    }
                    throw new Error(detail);
                }
                
                // Expect JSON response with preview_url
                const data = await response.json();
                console.log('Fill success:', { file_id: data.file_id, preview_url: data.preview_url });
                
                if (data.preview_url && data.file_id) {
                    currentFileId = data.file_id;
                    if (data.pdf_hash) {
                        currentPdfHash = data.pdf_hash;
                    }
                    // Use cache-busting query param to ensure fresh load
                    currentPreviewUrl = `${data.preview_url}?t=${Date.now()}`;
                    console.log('Setting preview iframe src:', currentPreviewUrl);
                    
                    // Set up fallback link
                    previewLink.href = data.preview_url;
                    previewFallback.style.display = 'none';
                    
                    // Handle iframe load/error events
                    previewIframe.onload = () => {
                        console.log('Preview iframe loaded successfully');
                        if (previewLoadTimeout) {
                            clearTimeout(previewLoadTimeout);
                            previewLoadTimeout = null;
                        }
                        previewFallback.style.display = 'none';
                    };
                    previewIframe.onerror = () => {
                        console.error('Preview iframe failed to load');
                        previewFallback.style.display = 'block';
                    };
                    
                    // Set timeout to show fallback if iframe doesn't load
                    previewLoadTimeout = setTimeout(() => {
                        console.warn('Preview iframe load timeout, showing fallback');
                        previewFallback.style.display = 'block';
                    }, 5000);
                    
                    previewIframe.src = currentPreviewUrl;
                    previewContainer.style.display = 'block';
                    previewContainer.setAttribute('data-has-preview', 'true');
                    mainContentGrid.classList.add('has-preview');
                    aiFixContainer.style.display = 'none';
                    
                    // Scroll to preview on mobile/tablet
                    if (window.innerWidth < 1024) {
                    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    setStatus(t('errors.fill_success'), false, true);
                } else {
                    throw new Error(t('errors.invalid_response'));
                }
            } catch (err) {
                setStatus(err.message, true);
                previewContainer.style.display = 'none';
                previewContainer.removeAttribute('data-has-preview');
                mainContentGrid.classList.remove('has-preview');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t('fill_my_form');
            }
        });
        
        // Close debug panel button
        const debugPanelClose = document.getElementById('debug-panel-close');
        if (debugPanelClose) {
            debugPanelClose.addEventListener('click', () => {
                const panel = document.getElementById('debug-panel');
                if (panel) panel.style.display = 'none';
            });
        }
        
        // Click-interceptor diagnostic (temporary but safe)
        (function setupClickDebug() {
            // Toggle by setting window.CLICK_DEBUG = true in console if needed
            window.CLICK_DEBUG = true;
            
            // Create visible debug element (bottom-left)
            const clickDebugEl = document.createElement('div');
            clickDebugEl.id = 'click-debug-info';
            clickDebugEl.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: #0f0;
                padding: 8px 12px;
                border-radius: 6px;
                font-family: monospace;
                font-size: 11px;
                z-index: 10002;
                max-width: 300px;
                word-break: break-word;
                display: block;
                pointer-events: none; /* Don't block clicks itself */
            `;
            clickDebugEl.textContent = 'Click anywhere to see element chain';
            document.body.appendChild(clickDebugEl);
            
            document.addEventListener('click', (e) => {
                if (!window.CLICK_DEBUG) return;
                const x = e.clientX, y = e.clientY;
                const topEl = document.elementFromPoint(x, y);
                let chain = [];
                let cur = topEl;
                for (let i = 0; i < 10 && cur; i++) {
                    const id = cur.id ? `#${cur.id}` : '';
                    const cls = cur.className ? `.${String(cur.className).trim().replace(/\s+/g, '.')}` : '';
                    chain.push(`${cur.tagName}${id}${cls}`);
                    cur = cur.parentElement;
                }
                const chainStr = chain.join(' -> ');
                console.log('CLICK DEBUG: target=', e.target, 'elementFromPoint=', topEl, 'chain=', chainStr);
                
                // Update visible debug element
                const info = `Click: ${e.target.tagName}${e.target.id ? '#' + e.target.id : ''}${e.target.className ? '.' + String(e.target.className).trim().replace(/\s+/g, '.') : ''}\nTop: ${topEl ? topEl.tagName + (topEl.id ? '#' + topEl.id : '') : 'none'}\nChain: ${chainStr.substring(0, 150)}${chainStr.length > 150 ? '...' : ''}`;
                clickDebugEl.textContent = info;
                
                // Also update debug panel
                if (typeof updateDebugPanel === 'function') {
                    updateDebugPanel(`CLICK: ${e.target.tagName}${e.target.id ? '#' + e.target.id : ''} -> Top: ${topEl ? topEl.tagName + (topEl.id ? '#' + topEl.id : '') : 'none'}`);
                }
            }, true); // capture phase to detect interception early
        })();
        
        }); // End DOMContentLoaded wrapper
    </script>
    <!-- Minimal frontend wiring -->
    <script src="/static/app.js" defer></script>
</body>
</html>
